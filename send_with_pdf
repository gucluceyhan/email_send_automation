import pandas as pd
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.application import MIMEApplication
import os
import configparser

# YapÄ±landÄ±rma dosyasÄ±nÄ± okuyun
config = configparser.ConfigParser()
config.read('config.ini')

# SMTP sunucu ayarlarÄ±
smtp_sunucu = config.get('SMTP', 'smtp_sunucu')
smtp_port = config.getint('SMTP', 'smtp_port')
kullanici_adi = config.get('SMTP', 'kullanici_adi')
sifre = config.get('SMTP', 'sifre')

# GÃ¶nderenin bilgileri
gonderen_adi = config.get('GONDEREN', 'gonderen_adi')
gonderen_tel = config.get('GONDEREN', 'gonderen_tel')
gonderen_web = config.get('GONDEREN', 'gonderen_web')
gonderen_eposta = config.get('GONDEREN', 'gonderen_eposta')

# Konu baÅŸlÄ±ÄŸÄ±
konu_basligi = config.get('EPOSTA', 'konu_basligi')

# E-posta gÃ¶vdesi (burada dÃ¼zenleyebilirsiniz)
eposta_govdesi = """
DeÄŸerli Ä°ÅŸ OrtaÄŸÄ±mÄ±z,

...


Hemen Ä°letiÅŸime GeÃ§in!
Daha fazla bilgi almak veya hizmetimizi deÄŸerlendirmek iÃ§in bizimle iletiÅŸime geÃ§in. Profesyonel ekibimiz, ihtiyaÃ§larÄ±nÄ±za Ã¶zel Ã§Ã¶zÃ¼mler sunmaya hazÄ±r.

ğŸ“ Telefon: {gonderen_tel}
ğŸ“§ E-posta: {gonderen_eposta}
ğŸŒ Web Sitemiz: {gonderen_web}

SaÄŸlÄ±klÄ± gÃ¼nler dileriz,

{gonderen_adi}
"""

# Excel dosyasÄ±ndan e-posta adreslerini ve diÄŸer bilgileri okuyun
excel_dosyasi = os.path.join(os.getcwd(), 'eposta_listesi.xlsx')
df = pd.read_excel(excel_dosyasi)

# SÃ¼tun isimlerini temizleyin
df.columns = df.columns.str.strip().str.lower().str.replace('-', '').str.replace(' ', '').str.replace('_', '')

# Her bir e-posta adresine e-posta gÃ¶nderin
for index, satir in df.iterrows():
    satir = satir.fillna('')  # Eksik deÄŸerleri boÅŸ string ile doldurun
    alici_eposta = satir['eposta']

    # E-posta mesajÄ±nÄ± oluÅŸturun
    mesaj = MIMEMultipart()
    mesaj['From'] = f"{gonderen_adi} <{kullanici_adi}>"
    mesaj['To'] = alici_eposta
    mesaj['Subject'] = konu_basligi

    # KiÅŸiselleÅŸtirilmiÅŸ e-posta gÃ¶vdesi
    eposta_govdesi_kisisel = eposta_govdesi.format(
        **satir.to_dict(),
        gonderen_adi=gonderen_adi,
        gonderen_tel=gonderen_tel,
        gonderen_eposta=gonderen_eposta,
        gonderen_web=gonderen_web
    )

    # E-posta gÃ¶vdesini ekleyin
    mesaj.attach(MIMEText(eposta_govdesi_kisisel, 'plain', 'utf-8'))

    # PDF ekini ekleyin
    pdf_dosyasi = os.path.join(os.getcwd(), 'SÄ±caklÄ±k Haritalama.pdf')
    with open(pdf_dosyasi, 'rb') as dosya:
        mime_pdf = MIMEApplication(dosya.read(), _subtype='pdf')
        mime_pdf.add_header('Content-Disposition', 'attachment', filename=os.path.basename(pdf_dosyasi))
        mesaj.attach(mime_pdf)

    # E-postayÄ± gÃ¶nderin
    try:
        sunucu = smtplib.SMTP(smtp_sunucu, smtp_port)
        sunucu.starttls()
        sunucu.login(kullanici_adi, sifre)
        sunucu.sendmail(kullanici_adi, alici_eposta, mesaj.as_string())
        sunucu.quit()
        print(f"{alici_eposta} adresine e-posta gÃ¶nderildi.")
    except Exception as e:
        print(f"{alici_eposta} adresine e-posta gÃ¶nderilemedi. Hata: {str(e)}")
